var oe=Object.defineProperty;var ae=(l,e,t)=>e in l?oe(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var o=(l,e,t)=>(ae(l,typeof e!="symbol"?e+"":e,t),t);import{g as G,D as ie,h as Q,i as Y,d as F,j as T,k as C,l as ee,m as N,v as R,u as c,c as f,a as I,w as B,T as H,o as v,e as g,t as te,q as $,C as re,s as ce,n as j,x as le,U as M,y as ue,z as he,A as de,F as P,b as V,r as pe,B as me,E as ve,p as fe,f as _e,G as ye}from"./index-CUQ9CjfO.js";import{B as x,I as ge,_ as se,b as xe,a as be}from"./HomeInfo-BOXRHld0.js";class D{constructor(e,t){o(this,"x");o(this,"y");o(this,"parent");o(this,"G");o(this,"H");o(this,"getF",()=>this.G+this.H);this.x=e,this.y=t,this.parent=null,this.G=0,this.H=0}}class ke{constructor(e,t,n){o(this,"map");o(this,"start");o(this,"end");o(this,"list");o(this,"find",()=>{var n;this.list.open.push(this.start);let e=this.step();if(!e)return console.info("无法生存路径!"),[];const t=[];for(;(n=e.parent)!=null&&n.parent;)e=e.parent,t.push(e);return t.reverse().push(this.end),t});o(this,"step",()=>{this.list.open.sort((n,s)=>n.getF()-s.getF());const e=this.list.open.shift();if(!e)return!1;this.list.close.push(e);const t=this.around(e);for(let n=0;n<t.length;n++){const s=t[n],i=this.isInList("open",s);if(s.parent=e,s.H=this.countH(s),s.G=this.countG(s)+e.G,!i){if(s.x===this.end.x&&s.y===this.end.y)return s;this.list.open.push(s);continue}e.G+this.countG(s)<this.list.open[i].G&&(this.list.open[i].parent=e)}return this.step()});o(this,"around",e=>{const t=[];for(let n=-1;n<=1;n++)for(let s=-1;s<=1;s++){if(n===0&&s===0||n!==0&&s!==0)continue;const i=e.x+n,a=e.y+s;if(i>=this.map.row||a>=this.map.col||i<0||a<0)continue;const r=new D(i,a);this.isInList("close",r)||this.isInList("stick",r)||t.push(r)}return t});o(this,"isInList",(e,t)=>{const n=this.list[e].findIndex(s=>s.x===t.x&&s.y===t.y);return n===-1?!1:n});o(this,"countH",e=>{const t=Math.abs(e.x-this.end.x),n=Math.abs(e.y-this.end.y);return(t+n)*10});o(this,"countG",e=>{const t=e.parent;return e.x!==t.x&&e.y!==t.y?14:10});this.map=e,this.start=new D(t.x,t.y),this.end=new D(n.x,n.y),this.list={open:[],close:[],stick:e.data.flat().filter(s=>s.type===x.STICK).map(s=>new D(s.x,s.y))}}}const K=(l,e,t,n)=>{let s=Number((Math.random()*(e-l)+l).toFixed(0));return t&&(s=Number((s*t).toFixed(0)),n&&s>n&&(s=n)),s},S=(l,e)=>({x:K(0,l-1),y:K(0,e-1)});class we{constructor(e={}){o(this,"row");o(this,"col");o(this,"lines");o(this,"inflex");o(this,"data");o(this,"create",()=>{for(let t=0;t<this.row;t++){const n=[];for(let s=0;s<this.col;s++)n.push({x:t,y:s,type:x.STICK});this.data.push(n)}let e=0;for(;;){const t=S(this.row,this.col),n=S(this.row,this.col);if(t.x-n.x>this.row*.5&&t.y-n.y>this.col*.5){this.createLine(t,n,!0);break}}for(let t=0;t<this.lines-1&&(this.createLine(S(this.row,this.col),S(this.row,this.col))&&t++,!(e++>100)););return this.data});o(this,"createLine",(e,t,n=!1)=>{const s=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);let a=e.x,r=e.y;const h={x:s,y:i},y=[];for(;a!==t.x&&r!==t.y;){const u=K(0,s,this.inflex,h.x);h.x-=u;for(let p=0;p<u;p++)e.x>t.x?y.push([a-p,r]):y.push([a+p,r]);e.x>t.x?a-=u:a+=u;let d=0;h.x===0?d=h.y:d=K(0,i,this.inflex,h.y),h.y-=d;for(let p=0;p<d;p++)e.y>t.y?y.push([a,r-p]):y.push([a,r+p]);e.y>t.y?r-=d:r+=d}if(!n){let u=!1;if(y.forEach(d=>{this.data[d[0]][d[1]].type===x.ROAD&&(u=!0)}),!u)return!1}return y.forEach(u=>{this.data[u[0]][u[1]].type=x.ROAD}),!0});this.row=e.row||20,this.col=e.col||20,this.lines=e.lines||10,this.inflex=e.inflex||.5,this.data=[],this.create()}}class Ie{constructor(e){o(this,"name");o(this,"id");o(this,"options");o(this,"chests");o(this,"dialogs");o(this,"map");o(this,"hero");o(this,"placeHero",()=>{const e=this.randomBlankBlocks(1)[0];return e.type=x.HERO,e});o(this,"placeEvents",()=>{const e=this.chests.concat(this.dialogs).map(s=>G(s)),t=e.length,n=this.randomBlankBlocks(t);for(let s=0;s<n.length;s++)n[s].event=e[s]});o(this,"generateChests",()=>{const e=[];for(let t=1;t<=this.options.chestNum;t++){const n=Math.ceil(Math.random()*14),s=Math.ceil(Math.random()*100);let i=0;s<=50?i=0:s>50&&s<=80?i=1:s>80&&s<=95?i=2:i=3;const a=5e6+i*14+n;e.push(a)}return e});o(this,"generateDialogs",()=>{const e=[];for(let t=1;t<=this.options.dialogNum;t++)e.push(7e6+Math.ceil(Math.random()*ie.length));return e});o(this,"randomBlankBlocks",e=>{const t=this.map.data.flat().filter(n=>n.type===x.ROAD&&!n.event).sort(()=>.5-Math.random());return t.slice(0,Math.min(e,t.length))});this.options=e,this.options.chestNum=e.chestNum||10,this.options.dialogNum=e.dialogNum||5,this.name=e.name,this.id=e.id,this.map=new we(e.mapOptions),this.chests=this.generateChests(),this.dialogs=this.generateDialogs(),this.hero=this.placeHero(),this.placeEvents()}}const Z="ArrowUp",X="ArrowDown",W="ArrowLeft",q="ArrowRight",J=280;class Me{constructor(e){o(this,"dungeon");o(this,"canMove");o(this,"onKeyUp");o(this,"autoMoveTimer");o(this,"start",()=>{this.onKeyUp=e=>{e.key&&(this.autoMoveTimer&&clearInterval(this.autoMoveTimer),this.move(e.key))},document.addEventListener("keyup",this.onKeyUp)});o(this,"stop",()=>{document.removeEventListener("keyup",this.onKeyUp),this.autoMoveTimer&&clearInterval(this.autoMoveTimer)});o(this,"move",e=>{if(!this.canMove)return;this.canMove=!1,setTimeout(()=>this.canMove=!0,J);const{hero:t,setHero:n}=Q(),{setEvent:s,emitUpdate:i}=Y();let a=this.dungeon.hero.x,r=this.dungeon.hero.y;if(t.canMove)switch(e){case Z:a--;break;case X:a++;break;case W:r--;break;case q:r++;break}const h=this.dungeon.map.data[a][r];!h||h.type!=x.ROAD||(this.dungeon.hero.type=x.ROAD,h.type=x.HERO,this.dungeon.hero=h,i("mapUpdate"),h.event&&(n("canMove",!1),s(h.event.type,{event:h.event,callback:()=>n("canMove",!0)}),delete h.event))});o(this,"autoMove",e=>{this.autoMoveTimer&&clearInterval(this.autoMoveTimer),this.autoMoveTimer=setInterval(()=>{const t=e.splice(0,1)[0];if(!t){this.autoMoveTimer&&clearInterval(this.autoMoveTimer);return}const n=this.dungeon.hero.x,s=this.dungeon.hero.y;let i="";switch(!0){case t.x<n:i=Z;break;case t.x>n:i=X;break;case t.y<s:i=W;break;case t.y>s:i=q;break}this.move(i),e.length<1&&this.autoMoveTimer!==null&&clearInterval(this.autoMoveTimer)},J+100)});this.dungeon=e,this.canMove=!0,this.onKeyUp=null,this.autoMoveTimer=null,this.start()}}const Ee={class:"mask"},Te={key:0,class:"relative flex flex-col h-50 w-75 bg-slate-100 rounded shadow-md p-2.5"},Ce={key:0,class:"bg-amber-200/60 rounded mb-1",p:"l-1.5 r-6 y-1"},Le=["innerHTML"],Oe={class:"flex-1 flex items-end justify-end"},Be={key:0,"space-x-1":""},$e=F({__name:"MapEvent",props:{eventItem:{type:[Object,Boolean]}},setup(l){const e=l,t=T(()=>e.eventItem?e.eventItem.event:void 0),n=T(()=>e.eventItem?e.eventItem.callback:void 0),s=C("init"),i=T(()=>{var m;return(m=t.value)==null?void 0:m.text[s.value]}),a=C(!1),r=C(!1),h=m=>{const _=G(m);return ge[_.grade||0]},y=m=>G(m).name,u=T(()=>{var E,A,z;const m=ne=>ne.map(U=>`<span style="color: ${h(U.itemId)}">
            ${y(U.itemId)}
          </span>
          *
          <span>${U.num}</span>`).join("");let _=((E=t.value)==null?void 0:E.text.data)||"";return(A=t.value)!=null&&A.need&&(_=_.replace(/{need}/g,m(t.value.need))),(z=t.value)!=null&&z.get&&(_=_.replace(/{get}/g,m(t.value.get))),_});ee(e,()=>{e.eventItem&&(s.value="init",a.value=!0,r.value=!1)});const{getItems:d,costItems:p,hasEnoughItems:k}=Q(),L=()=>{var m,_,E;(m=t.value)!=null&&m.need&&(k(t.value.need)?p((_=t.value)==null?void 0:_.need):s.value="noEnoughForExchange"),s.value!=="noEnoughForExchange"&&((E=t.value)!=null&&E.get)&&(d(t.value.get).length?s.value="noEnoughRoom":s.value="success"),r.value=!0},O=()=>{s.value="reject",r.value=!0},{setEvent:b}=Y(),w=()=>{n.value&&n.value(),a.value=!1,b(t.value.type,!1)};return(m,_)=>N((v(),f("div",Ee,[I(H,{"enter-active-class":"animate__animated animate__faster animate__zoomIn"},{default:B(()=>[c(a)?(v(),f("div",Te,[g("button",{class:"i-ic:round-close absolute top-4.5 right-4 text-sm bg-gray-600 duration-200 cursor-pointer hover:bg-gray-800 hover:rotate-90",onClick:w}),c(i)?(v(),f("div",Ce,te(c(i)),1)):$("",!0),c(r)?$("",!0):(v(),f("div",{key:1,class:"bg-gray-300/80 rounded px-1.5 py-1 mb-1",innerHTML:c(u)},null,8,Le)),g("div",Oe,[c(r)?(v(),f("button",{key:1,class:"action bg-gray-300/80",onClick:w},"结束")):(v(),f("div",Be,[g("button",{class:"action bg-blue-400/50",onClick:L},"同意"),g("button",{class:"action bg-rose-200",onClick:O},"拒绝")]))])])):$("",!0)]),_:1})],512)),[[R,c(a)]])}}),De={key:0,"i-ic:baseline-catching-pokemon":""},Se={key:1,"i-mdi:treasure-chest-outline":""},He={key:2,"i-typcn:info-large-outline":""},Ke=F({__name:"MapBlock",props:{block:{},map:{}},emits:["autoMove"],setup(l){const e=l,t=x.STICK,n=T(()=>Object.entries(x).find(a=>a[1]===e.block.type)[0].toLowerCase()),s=T(()=>{const{event:a,type:r}=e.block;return r!=x.ROAD||a?"bg-road":"bg-stick"}),i=T(()=>{const{x:a,y:r,type:h,event:y}=e.block,u=[n.value,(y==null?void 0:y.type)||""];return Object.entries({tl:[-1,-1],tr:[-1,1],bl:[1,-1],br:[1,1]}).forEach(([p,[k,L]])=>{const O=[0,1,2].map(b=>{const[w,m]=[[a+k,r],[a,r+L],[a+k,r+L]][b];return e.map[w]&&e.map[w][m]?e.map[w][m].type:t});h==t?O.every(b=>b!=t)&&u.push(`r-${p}`):O.slice(0,2).every(b=>b===t)&&u.push(`r-${p}`)}),u});return(a,r)=>(v(),f("div",{class:j(c(s)),onClick:r[0]||(r[0]=h=>a.$emit("autoMove"))},[g("div",{class:j(["map-block text-white text-lg flex-center",c(i)]),style:le({width:`${c(M).BLOCK_SIZE}px`,height:`${c(M).BLOCK_SIZE}px`})},[c(i).includes("hero")?(v(),f("span",De)):c(i).includes(c(re))?(v(),f("span",Se)):c(i).includes(c(ce))?(v(),f("span",He)):$("",!0)],6)],2))}}),Ae=se(Ke,[["__scopeId","data-v-8aaf87ad"]]),Ue=l=>(fe("data-v-0a1328f7"),l=l(),_e(),l),Ge={class:"h-full relative overflow-hidden bg-stick"},Ne={key:0,"i-ic:round-arrow-left":""},Re={key:1,"i-ic:round-arrow-right":""},je={key:0,class:"z-10 w-38 p-2 bg-black/40 rounded-bl",pos:"absolute top-0 right-0",text:"white right"},Ye=Ue(()=>g("div",{class:"hstack justify-end space-x-1 mt-1"},[g("div",{class:"tip-block bg-chest"},"包裹"),g("div",{class:"tip-block bg-event"},"事件"),g("div",{class:"tip-block bg-hero"},"你")],-1)),Fe=F({__name:"map",setup(l){const e=C(!1),t=C(!0);setTimeout(()=>t.value=!1,5e3);const{event:n}=Y(),s=C(new Ie({id:8000001,name:"世界"})),i=ye();ee(()=>n.mapUpdate,()=>{var u;return(u=i==null?void 0:i.proxy)==null?void 0:u.$forceUpdate()});const a=C(),r=()=>{if(!a.value)return;const{x:u,y:d}=s.value.hero,{row:p,col:k}=s.value.map;a.value.style.left=(M.WIDTH-M.BLOCK_SIZE*p)/2-(d-(k-1)/2)*M.BLOCK_SIZE+"px",a.value.style.top=(M.HEIGHT-M.BLOCK_SIZE*k)/2-(u-(p-1)/2)*M.BLOCK_SIZE+"px"};ue(r),he(r);const h=new Me(s.value),y=u=>{const d=new ke(s.value.map,s.value.hero,u).find();h.autoMove(d)};return de(h.stop),(u,d)=>{const p=pe("router-link"),k=xe,L=be,O=Ae,b=$e;return v(),f("div",Ge,[I(p,{class:"btn z-10 w-15 py-1 hover:bg-white hover:text-slate-700",pos:"absolute bottom-4 right-4",border:"white rounded",to:"/"},{default:B(()=>[me(" 回城 ")]),_:1}),I(H,{"enter-active-class":"animate__animated animate__faster animate__slideInUp","leave-active-class":"animate__animated animate__faster animate__slideOutDown"},{default:B(()=>[N(I(k,{class:"hero-info bottom-0 h-[270px] pt-2 pb-1 rounded-tr"},null,512),[[R,c(e)]])]),_:1}),I(H,{"enter-active-class":"animate__animated animate__faster animate__slideInDown","leave-active-class":"animate__animated animate__faster animate__slideOutUp"},{default:B(()=>[N(I(L,{transition:"bounce",class:"hero-info flex items-start space-x-6 pt-1 rounded-br"},null,512),[[R,c(e)]])]),_:1}),g("div",{class:j(["z-20 w-10 py-1 bg-gray-400 duration-500 cursor-pointer",[c(e)?"left-0":"-left-5"]]),text:"white right",border:"y r gray-300/50 rounded-r",pos:"absolute top-[199px]",onClick:d[0]||(d[0]=w=>e.value=!c(e))},[c(e)?(v(),f("span",Ne)):(v(),f("span",Re))],2),I(H,{"enter-active-class":"animate__animated animate__slideInRight","leave-active-class":"animate__animated animate__slideOutRight"},{default:B(()=>[c(t)?(v(),f("div",je,[g("div",null,te(c(s).name),1),Ye])):$("",!0)]),_:1}),g("div",{ref_key:"map",ref:a,class:"absolute duration-200 h-[800px] w-[800px]"},[(v(!0),f(P,null,V(c(s).map.data,(w,m)=>(v(),f("div",{key:`line-${m}`,class:"flex leading-0"},[(v(!0),f(P,null,V(w,(_,E)=>(v(),ve(O,{key:`block-${E}`,block:_,map:c(s).map.data,onAutoMove:A=>y(_)},null,8,["block","map","onAutoMove"]))),128))]))),128))],512),I(b,{"event-item":c(n).chest},null,8,["event-item"]),I(b,{"event-item":c(n).dialog},null,8,["event-item"])])}}}),Ze=se(Fe,[["__scopeId","data-v-0a1328f7"]]);export{Ze as default};
