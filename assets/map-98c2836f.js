var oe=Object.defineProperty;var ae=(l,e,t)=>e in l?oe(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var o=(l,e,t)=>(ae(l,typeof e!="symbol"?e+"":e,t),t);import{g as U,l as Q,h as Z,i as j,d as F,j as L,k as C,m as ee,q as K,v as Y,u as c,c as f,a as w,w as $,T as S,o as _,e as x,t as te,s as B,C as ie,D as re,n as G,x as ce,y as le,z as ue,r as he,F as z,b as P,A as de,B as pe,p as me,f as ve,E as _e}from"./index-7e7f06c1.js";import{B as g,I as fe,_ as se,b as ye,a as ge}from"./HomeInfo-d42cf724.js";class H{constructor(e,t){o(this,"x");o(this,"y");o(this,"parent");o(this,"G");o(this,"H");o(this,"getF",()=>this.G+this.H);this.x=e,this.y=t,this.parent=null,this.G=0,this.H=0}}class xe{constructor(e,t,n){o(this,"map");o(this,"start");o(this,"end");o(this,"list");o(this,"find",()=>{var n;this.list.open.push(this.start);let e=this.step();if(!e)return console.info("无法生存路径!"),[];const t=[];for(;(n=e.parent)!=null&&n.parent;)e=e.parent,t.push(e);return t.reverse().push(this.end),t});o(this,"step",()=>{this.list.open.sort((n,s)=>n.getF()-s.getF());const e=this.list.open.shift();if(!e)return!1;this.list.close.push(e);const t=this.around(e);for(let n=0;n<t.length;n++){const s=t[n],r=this.isInList("open",s);if(s.parent=e,s.H=this.countH(s),s.G=this.countG(s)+e.G,!r){if(s.x===this.end.x&&s.y===this.end.y)return s;this.list.open.push(s);continue}e.G+this.countG(s)<this.list.open[r].G&&(this.list.open[r].parent=e)}return this.step()});o(this,"around",e=>{const t=[];for(let n=-1;n<=1;n++)for(let s=-1;s<=1;s++){if(n===0&&s===0||n!==0&&s!==0)continue;const r=e.x+n,a=e.y+s;if(r>=this.map.row||a>=this.map.col||r<0||a<0)continue;const i=new H(r,a);this.isInList("close",i)||this.isInList("stick",i)||t.push(i)}return t});o(this,"isInList",(e,t)=>{const n=this.list[e].findIndex(s=>s.x===t.x&&s.y===t.y);return n===-1?!1:n});o(this,"countH",e=>{const t=Math.abs(e.x-this.end.x),n=Math.abs(e.y-this.end.y);return(t+n)*10});o(this,"countG",e=>{const t=e.parent;return e.x!==t.x&&e.y!==t.y?14:10});this.map=e,this.start=new H(t.x,t.y),this.end=new H(n.x,n.y),this.list={open:[],close:[],stick:e.data.flat().filter(s=>s.type===g.STICK).map(s=>new H(s.x,s.y))}}}const A=(l,e,t,n)=>{let s=Number((Math.random()*(e-l)+l).toFixed(0));return t&&(s=Number((s*t).toFixed(0)),n&&s>n&&(s=n)),s},O=(l,e)=>({x:A(0,l-1),y:A(0,e-1)});class be{constructor(e={}){o(this,"row");o(this,"col");o(this,"lines");o(this,"inflex");o(this,"data");o(this,"create",()=>{for(let t=0;t<this.row;t++){const n=[];for(let s=0;s<this.col;s++)n.push({x:t,y:s,type:g.STICK});this.data.push(n)}let e=0;for(;;){const t=O(this.row,this.col),n=O(this.row,this.col);if(t.x-n.x>this.row*.5&&t.y-n.y>this.col*.5){this.createLine(t,n,!0);break}}for(let t=0;t<this.lines-1&&(this.createLine(O(this.row,this.col),O(this.row,this.col))&&t++,!(e++>100)););return this.data});o(this,"createLine",(e,t,n=!1)=>{const s=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y);let a=e.x,i=e.y;const h={x:s,y:r},y=[];for(;a!==t.x&&i!==t.y;){const v=A(0,s,this.inflex,h.x);h.x-=v;for(let p=0;p<v;p++)e.x>t.x?y.push([a-p,i]):y.push([a+p,i]);e.x>t.x?a-=v:a+=v;let u=0;h.x===0?u=h.y:u=A(0,r,this.inflex,h.y),h.y-=u;for(let p=0;p<u;p++)e.y>t.y?y.push([a,i-p]):y.push([a,i+p]);e.y>t.y?i-=u:i+=u}if(!n){let v=!1;if(y.forEach(u=>{this.data[u[0]][u[1]].type===g.ROAD&&(v=!0)}),!v)return!1}return y.forEach(v=>{this.data[v[0]][v[1]].type=g.ROAD}),!0});this.row=e.row||20,this.col=e.col||20,this.lines=e.lines||10,this.inflex=e.inflex||.5,this.data=[],this.create()}}class ke{constructor(e){o(this,"name");o(this,"id");o(this,"options");o(this,"chests");o(this,"dialogs");o(this,"map");o(this,"hero");o(this,"placeHero",()=>{const e=this.randomBlankBlocks(1)[0];return e.type=g.HERO,e});o(this,"placeEvents",()=>{const e=this.chests.concat(this.dialogs).map(s=>U(s)),t=e.length,n=this.randomBlankBlocks(t);for(let s=0;s<n.length;s++)n[s].event=e[s]});o(this,"generateChests",()=>{const e=[];for(let t=1;t<=this.options.chestNum;t++){const n=Math.ceil(Math.random()*14),s=Math.ceil(Math.random()*100);let r=0;s<=50?r=0:s>50&&s<=80?r=1:s>80&&s<=95?r=2:r=3;const a=5e6+r*14+n;e.push(a)}return e});o(this,"generateDialogs",()=>{const e=[];for(let t=1;t<=this.options.dialogNum;t++)e.push(7e6+Math.ceil(Math.random()*10));return e});o(this,"randomBlankBlocks",e=>Q.sampleSize(this.map.data.flat().filter(t=>t.type===g.ROAD&&!t.event),e));this.options=e,this.options.chestNum=e.chestNum||10,this.options.dialogNum=e.dialogNum||5,this.name=e.name,this.id=e.id,this.map=new be(e.mapOptions),this.chests=this.generateChests(),this.dialogs=this.generateDialogs(),this.hero=this.placeHero(),this.placeEvents()}}const V="ArrowUp",X="ArrowDown",W="ArrowLeft",q="ArrowRight",J=280;class we{constructor(e){o(this,"dungeon");o(this,"canMove");o(this,"onKeyUp");o(this,"autoMoveTimer");o(this,"start",()=>{this.onKeyUp=e=>{e.key&&(this.autoMoveTimer&&clearInterval(this.autoMoveTimer),this.move(e.key))},document.addEventListener("keyup",this.onKeyUp)});o(this,"stop",()=>{document.removeEventListener("keyup",this.onKeyUp),this.autoMoveTimer&&clearInterval(this.autoMoveTimer)});o(this,"move",e=>{if(!this.canMove)return;this.canMove=!1,setTimeout(()=>this.canMove=!0,J);const{hero:t,setHero:n}=Z(),{setEvent:s,emitUpdate:r}=j();let a=this.dungeon.hero.x,i=this.dungeon.hero.y;if(t.canMove)switch(e){case V:a--;break;case X:a++;break;case W:i--;break;case q:i++;break}const h=this.dungeon.map.data[a][i];!h||h.type!=g.ROAD||(this.dungeon.hero.type=g.ROAD,h.type=g.HERO,this.dungeon.hero=h,r("mapUpdate"),h.event&&(n("canMove",!1),s(h.event.type,{event:h.event,callback:()=>n("canMove",!0)}),delete h.event))});o(this,"autoMove",e=>{this.autoMoveTimer&&clearInterval(this.autoMoveTimer),this.autoMoveTimer=setInterval(()=>{const t=e.splice(0,1)[0];if(!t){this.autoMoveTimer&&clearInterval(this.autoMoveTimer);return}const n=this.dungeon.hero.x,s=this.dungeon.hero.y;let r="";switch(!0){case t.x<n:r=V;break;case t.x>n:r=X;break;case t.y<s:r=W;break;case t.y>s:r=q;break}this.move(r),e.length<1&&this.autoMoveTimer!==null&&clearInterval(this.autoMoveTimer)},J+100)});this.dungeon=e,this.canMove=!0,this.onKeyUp=null,this.autoMoveTimer=null,this.start()}}const Me={class:"mask"},Ie={key:0,class:"relative flex flex-col h-50 w-75 bg-slate-100 rounded shadow-md p-2.5"},Ee={key:0,class:"bg-amber-200/60 rounded pl-1.5 pr-6 py-1 mb-1"},Te=["innerHTML"],Ce={class:"flex-1 flex items-end justify-end"},Le={key:0,"space-x-1":""},$e=F({__name:"MapEvent",props:{eventItem:{type:[Object,Boolean]}},setup(l){const e=l,t=L(()=>e.eventItem?e.eventItem.event:void 0),n=L(()=>e.eventItem?e.eventItem.callback:void 0),s=C("init"),r=L(()=>{var d;return(d=t.value)==null?void 0:d.text[s.value]}),a=C(!1),i=C(!1),h=d=>{const m=U(d);return fe[m.grade||0]},y=d=>U(d).name,v=L(()=>{var T,D,N;const d=ne=>ne.map(R=>`<span style="color: ${h(R.itemId)}">
            ${y(R.itemId)}
          </span>
          *
          <span>${R.num}</span>`).join("");let m=((T=t.value)==null?void 0:T.text.data)||"";return(D=t.value)!=null&&D.need&&(m=m.replace(/{need}/g,d(t.value.need))),(N=t.value)!=null&&N.get&&(m=m.replace(/{get}/g,d(t.value.get))),m});ee(e,()=>{e.eventItem&&(s.value="init",a.value=!0,i.value=!1)});const{getItems:u,costItems:p,hasEnoughItems:M}=Z(),b=()=>{var d,m,T;(d=t.value)!=null&&d.need&&(M(t.value.need)?p((m=t.value)==null?void 0:m.need):s.value="noEnoughForExchange"),s.value!=="noEnoughForExchange"&&((T=t.value)!=null&&T.get)&&(u(t.value.get).length?s.value="noEnoughRoom":s.value="success"),i.value=!0},I=()=>{s.value="reject",i.value=!0},{setEvent:E}=j(),k=()=>{n.value&&n.value(),a.value=!1,E(t.value.type,!1)};return(d,m)=>K((_(),f("div",Me,[w(S,{"enter-active-class":"animate__animated animate__faster animate__zoomIn"},{default:$(()=>[c(a)?(_(),f("div",Ie,[x("button",{class:"i-ic:round-close absolute top-4.5 right-4 text-sm bg-gray-600 duration-200 cursor-pointer hover:bg-gray-800 hover:rotate-90",onClick:k}),c(r)?(_(),f("div",Ee,te(c(r)),1)):B("",!0),c(i)?B("",!0):(_(),f("div",{key:1,class:"bg-gray-300/80 rounded px-1.5 py-1 mb-1",innerHTML:c(v)},null,8,Te)),x("div",Ce,[c(i)?(_(),f("button",{key:1,class:"action bg-gray-300/80",onClick:k},"结束")):(_(),f("div",Le,[x("button",{class:"action bg-blue-400/50",onClick:b},"同意"),x("button",{class:"action bg-rose-200",onClick:I},"拒绝")]))])])):B("",!0)]),_:1})],512)),[[Y,c(a)]])}}),Be={key:0,"i-ic:baseline-catching-pokemon":""},De={key:1,"i-mdi:treasure-chest-outline":""},He={key:2,"i-typcn:info-large-outline":""},Oe=F({__name:"MapBlock",props:{block:{},map:{}},emits:["autoMove"],setup(l){const e=l,t=g.STICK,n=L(()=>{var a;return(a=Object.keys(g).find(i=>g[i]===e.block.type))==null?void 0:a.toLowerCase()}),s=L(()=>{const{event:a,type:i}=e.block;return i!=g.ROAD||a?"bg-road":"bg-stick"}),r=L(()=>{const{x:a,y:i,type:h,event:y}=e.block,v=[n.value,(y==null?void 0:y.type)||""],u={tl:[-1,-1],tr:[-1,1],bl:[1,-1],br:[1,1]};for(const p in u){const M=Q.map(new Array(3),(b,I)=>{const[E,k]=u[p],[d,m]=[[a+E,i],[a,i+k],[a+E,i+k]][I];return e.map[d]&&e.map[d][m]?e.map[d][m].type:t});h==t?M.every(b=>b!=t)&&v.push(`r-${p}`):M.slice(0,2).every(b=>b===t)&&v.push(`r-${p}`)}return v});return(a,i)=>(_(),f("div",{class:G(c(s)),onClick:i[0]||(i[0]=h=>a.$emit("autoMove"))},[x("div",{class:G(["map-block h-10 w-10 text-white text-lg flex-center",c(r)])},[c(r).includes("hero")?(_(),f("span",Be)):c(r).includes(c(ie))?(_(),f("span",De)):c(r).includes(c(re))?(_(),f("span",He)):B("",!0)],2)],2))}});const Se=se(Oe,[["__scopeId","data-v-97102640"]]),Ae=l=>(me("data-v-bc917143"),l=l(),ve(),l),Ne={key:0,"i-ic:round-arrow-left":""},Re={key:1,"i-ic:round-arrow-right":""},Ue={key:0,class:"absolute z-10 top-0 right-0 w-38 text-white text-right bg-black/40 rounded-bl p-2"},Ke=Ae(()=>x("div",{class:"hstack justify-end space-x-1 mt-1"},[x("div",{class:"tip-block bg-chest"},"包裹"),x("div",{class:"tip-block bg-event"},"事件"),x("div",{class:"tip-block bg-hero"},"你")],-1)),Ye=F({__name:"map",setup(l){const e=C(!1),t=C(!0);setTimeout(()=>t.value=!1,5e3);const{event:n}=j(),s=C(new ke({id:8000001,name:"世界"})),r=_e();ee(()=>n.mapUpdate,()=>{var u;return(u=r==null?void 0:r.proxy)==null?void 0:u.$forceUpdate()});const a=C(),i=C(),h=()=>{const u=document.querySelector(".map-block");if(!a.value||!i.value||!u)return;const p=a.value.offsetWidth,M=a.value.offsetHeight,b=u.offsetWidth,I=u.offsetHeight,{x:E,y:k}=s.value.hero,{row:d,col:m}=s.value.map;i.value.style.left=(p-b*d)/2-(k-(m-1)/2)*b+"px",i.value.style.top=(M-I*m)/2-(E-(d-1)/2)*I+"px"};ce(h),le(h);const y=new we(s.value),v=u=>{const p=new xe(s.value.map,s.value.hero,u).find();y.autoMove(p)};return ue(()=>y.stop()),(u,p)=>{const M=he("router-link"),b=ye,I=ge,E=Se,k=$e;return _(),f("div",{ref_key:"container",ref:a,class:"h-full relative overflow-hidden bg-stick"},[w(M,{class:"btn absolute z-9 bottom-4 right-4 w-15 py-1 rounded border-white hover:bg-white hover:text-slate-700",to:"/"},{default:$(()=>[de(" 回城 ")]),_:1}),w(S,{"enter-active-class":"animate__animated animate__faster animate__slideInUp","leave-active-class":"animate__animated animate__faster animate__slideOutDown"},{default:$(()=>[K(w(b,{class:"absolute z-2 w-[524px] h-[270px] bg-background rounded-tr bottom-0 pt-2 pb-1"},null,512),[[Y,c(e)]])]),_:1}),w(S,{"enter-active-class":"animate__animated animate__faster animate__slideInDown","leave-active-class":"animate__animated animate__faster animate__slideOutUp"},{default:$(()=>[K(w(I,{transition:"bounce",class:"absolute z-2 w-[524px] bg-background rounded-br flex items-start space-x-10 pt-1"},null,512),[[Y,c(e)]])]),_:1}),x("div",{class:G(["absolute top-[199px] -left-5 z-2 w-10 py-1 bg-gray-400 text-white text-right duration-500 cursor-pointer",[c(e)&&"left-0"]]),border:"y r gray-300/50 rounded-r",onClick:p[0]||(p[0]=d=>e.value=!c(e))},[c(e)?(_(),f("span",Ne)):(_(),f("span",Re))],2),w(S,{"enter-active-class":"animate__animated animate__slideInRight","leave-active-class":"animate__animated animate__slideOutRight"},{default:$(()=>[c(t)?(_(),f("div",Ue,[x("div",null,te(c(s).name),1),Ke])):B("",!0)]),_:1}),x("div",{ref_key:"map",ref:i,class:"absolute duration-200 h-[800px] w-[800px]"},[(_(!0),f(z,null,P(c(s).map.data,(d,m)=>(_(),f("div",{key:`line-${m}`,class:"flex leading-0"},[(_(!0),f(z,null,P(d,(T,D)=>(_(),pe(E,{key:`block-${D}`,block:T,map:c(s).map.data,onAutoMove:N=>v(T)},null,8,["block","map","onAutoMove"]))),128))]))),128))],512),w(k,{"event-item":c(n).chest},null,8,["event-item"]),w(k,{"event-item":c(n).dialog},null,8,["event-item"])],512)}}});const ze=se(Ye,[["__scopeId","data-v-bc917143"]]);export{ze as default};
