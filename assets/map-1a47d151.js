var ae=Object.defineProperty;var ie=(l,e,t)=>e in l?ae(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var o=(l,e,t)=>(ie(l,typeof e!="symbol"?e+"":e,t),t);import{g as G,D as re,l as Q,h as ee,i as j,d as F,j as C,k as L,m as te,q as N,v as R,u as c,c as f,a as b,w as O,T as H,o as _,e as x,t as se,s as S,C as ce,x as le,n as Y,y as ue,U as M,z as he,A as de,B as pe,r as me,F as P,b as V,E as ve,G as _e,p as fe,f as ye,H as ge}from"./index-4da286f9.js";import{B as g,I as xe,_ as ne,b as ke,a as be}from"./HomeInfo-58b184af.js";class ${constructor(e,t){o(this,"x");o(this,"y");o(this,"parent");o(this,"G");o(this,"H");o(this,"getF",()=>this.G+this.H);this.x=e,this.y=t,this.parent=null,this.G=0,this.H=0}}class we{constructor(e,t,n){o(this,"map");o(this,"start");o(this,"end");o(this,"list");o(this,"find",()=>{var n;this.list.open.push(this.start);let e=this.step();if(!e)return console.info("无法生存路径!"),[];const t=[];for(;(n=e.parent)!=null&&n.parent;)e=e.parent,t.push(e);return t.reverse().push(this.end),t});o(this,"step",()=>{this.list.open.sort((n,s)=>n.getF()-s.getF());const e=this.list.open.shift();if(!e)return!1;this.list.close.push(e);const t=this.around(e);for(let n=0;n<t.length;n++){const s=t[n],i=this.isInList("open",s);if(s.parent=e,s.H=this.countH(s),s.G=this.countG(s)+e.G,!i){if(s.x===this.end.x&&s.y===this.end.y)return s;this.list.open.push(s);continue}e.G+this.countG(s)<this.list.open[i].G&&(this.list.open[i].parent=e)}return this.step()});o(this,"around",e=>{const t=[];for(let n=-1;n<=1;n++)for(let s=-1;s<=1;s++){if(n===0&&s===0||n!==0&&s!==0)continue;const i=e.x+n,a=e.y+s;if(i>=this.map.row||a>=this.map.col||i<0||a<0)continue;const r=new $(i,a);this.isInList("close",r)||this.isInList("stick",r)||t.push(r)}return t});o(this,"isInList",(e,t)=>{const n=this.list[e].findIndex(s=>s.x===t.x&&s.y===t.y);return n===-1?!1:n});o(this,"countH",e=>{const t=Math.abs(e.x-this.end.x),n=Math.abs(e.y-this.end.y);return(t+n)*10});o(this,"countG",e=>{const t=e.parent;return e.x!==t.x&&e.y!==t.y?14:10});this.map=e,this.start=new $(t.x,t.y),this.end=new $(n.x,n.y),this.list={open:[],close:[],stick:e.data.flat().filter(s=>s.type===g.STICK).map(s=>new $(s.x,s.y))}}}const A=(l,e,t,n)=>{let s=Number((Math.random()*(e-l)+l).toFixed(0));return t&&(s=Number((s*t).toFixed(0)),n&&s>n&&(s=n)),s},D=(l,e)=>({x:A(0,l-1),y:A(0,e-1)});class Ie{constructor(e={}){o(this,"row");o(this,"col");o(this,"lines");o(this,"inflex");o(this,"data");o(this,"create",()=>{for(let t=0;t<this.row;t++){const n=[];for(let s=0;s<this.col;s++)n.push({x:t,y:s,type:g.STICK});this.data.push(n)}let e=0;for(;;){const t=D(this.row,this.col),n=D(this.row,this.col);if(t.x-n.x>this.row*.5&&t.y-n.y>this.col*.5){this.createLine(t,n,!0);break}}for(let t=0;t<this.lines-1&&(this.createLine(D(this.row,this.col),D(this.row,this.col))&&t++,!(e++>100)););return this.data});o(this,"createLine",(e,t,n=!1)=>{const s=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);let a=e.x,r=e.y;const h={x:s,y:i},y=[];for(;a!==t.x&&r!==t.y;){const u=A(0,s,this.inflex,h.x);h.x-=u;for(let p=0;p<u;p++)e.x>t.x?y.push([a-p,r]):y.push([a+p,r]);e.x>t.x?a-=u:a+=u;let d=0;h.x===0?d=h.y:d=A(0,i,this.inflex,h.y),h.y-=d;for(let p=0;p<d;p++)e.y>t.y?y.push([a,r-p]):y.push([a,r+p]);e.y>t.y?r-=d:r+=d}if(!n){let u=!1;if(y.forEach(d=>{this.data[d[0]][d[1]].type===g.ROAD&&(u=!0)}),!u)return!1}return y.forEach(u=>{this.data[u[0]][u[1]].type=g.ROAD}),!0});this.row=e.row||20,this.col=e.col||20,this.lines=e.lines||10,this.inflex=e.inflex||.5,this.data=[],this.create()}}class Me{constructor(e){o(this,"name");o(this,"id");o(this,"options");o(this,"chests");o(this,"dialogs");o(this,"map");o(this,"hero");o(this,"placeHero",()=>{const e=this.randomBlankBlocks(1)[0];return e.type=g.HERO,e});o(this,"placeEvents",()=>{const e=this.chests.concat(this.dialogs).map(s=>G(s)),t=e.length,n=this.randomBlankBlocks(t);for(let s=0;s<n.length;s++)n[s].event=e[s]});o(this,"generateChests",()=>{const e=[];for(let t=1;t<=this.options.chestNum;t++){const n=Math.ceil(Math.random()*14),s=Math.ceil(Math.random()*100);let i=0;s<=50?i=0:s>50&&s<=80?i=1:s>80&&s<=95?i=2:i=3;const a=5e6+i*14+n;e.push(a)}return e});o(this,"generateDialogs",()=>{const e=[];for(let t=1;t<=this.options.dialogNum;t++)e.push(7e6+Math.ceil(Math.random()*re.length));return e});o(this,"randomBlankBlocks",e=>Q.sampleSize(this.map.data.flat().filter(t=>t.type===g.ROAD&&!t.event),e));this.options=e,this.options.chestNum=e.chestNum||10,this.options.dialogNum=e.dialogNum||5,this.name=e.name,this.id=e.id,this.map=new Ie(e.mapOptions),this.chests=this.generateChests(),this.dialogs=this.generateDialogs(),this.hero=this.placeHero(),this.placeEvents()}}const Z="ArrowUp",X="ArrowDown",W="ArrowLeft",q="ArrowRight",J=280;class Ee{constructor(e){o(this,"dungeon");o(this,"canMove");o(this,"onKeyUp");o(this,"autoMoveTimer");o(this,"start",()=>{this.onKeyUp=e=>{e.key&&(this.autoMoveTimer&&clearInterval(this.autoMoveTimer),this.move(e.key))},document.addEventListener("keyup",this.onKeyUp)});o(this,"stop",()=>{document.removeEventListener("keyup",this.onKeyUp),this.autoMoveTimer&&clearInterval(this.autoMoveTimer)});o(this,"move",e=>{if(!this.canMove)return;this.canMove=!1,setTimeout(()=>this.canMove=!0,J);const{hero:t,setHero:n}=ee(),{setEvent:s,emitUpdate:i}=j();let a=this.dungeon.hero.x,r=this.dungeon.hero.y;if(t.canMove)switch(e){case Z:a--;break;case X:a++;break;case W:r--;break;case q:r++;break}const h=this.dungeon.map.data[a][r];!h||h.type!=g.ROAD||(this.dungeon.hero.type=g.ROAD,h.type=g.HERO,this.dungeon.hero=h,i("mapUpdate"),h.event&&(n("canMove",!1),s(h.event.type,{event:h.event,callback:()=>n("canMove",!0)}),delete h.event))});o(this,"autoMove",e=>{this.autoMoveTimer&&clearInterval(this.autoMoveTimer),this.autoMoveTimer=setInterval(()=>{const t=e.splice(0,1)[0];if(!t){this.autoMoveTimer&&clearInterval(this.autoMoveTimer);return}const n=this.dungeon.hero.x,s=this.dungeon.hero.y;let i="";switch(!0){case t.x<n:i=Z;break;case t.x>n:i=X;break;case t.y<s:i=W;break;case t.y>s:i=q;break}this.move(i),e.length<1&&this.autoMoveTimer!==null&&clearInterval(this.autoMoveTimer)},J+100)});this.dungeon=e,this.canMove=!0,this.onKeyUp=null,this.autoMoveTimer=null,this.start()}}const Te={class:"mask"},Ce={key:0,class:"relative flex flex-col h-50 w-75 bg-slate-100 rounded shadow-md p-2.5"},Le={key:0,class:"bg-amber-200/60 rounded pl-1.5 pr-6 py-1 mb-1"},Be=["innerHTML"],Oe={class:"flex-1 flex items-end justify-end"},Se={key:0,"space-x-1":""},$e=F({__name:"MapEvent",props:{eventItem:{type:[Object,Boolean]}},setup(l){const e=l,t=C(()=>e.eventItem?e.eventItem.event:void 0),n=C(()=>e.eventItem?e.eventItem.callback:void 0),s=L("init"),i=C(()=>{var m;return(m=t.value)==null?void 0:m.text[s.value]}),a=L(!1),r=L(!1),h=m=>{const v=G(m);return xe[v.grade||0]},y=m=>G(m).name,u=C(()=>{var T,K,z;const m=oe=>oe.map(U=>`<span style="color: ${h(U.itemId)}">
            ${y(U.itemId)}
          </span>
          *
          <span>${U.num}</span>`).join("");let v=((T=t.value)==null?void 0:T.text.data)||"";return(K=t.value)!=null&&K.need&&(v=v.replace(/{need}/g,m(t.value.need))),(z=t.value)!=null&&z.get&&(v=v.replace(/{get}/g,m(t.value.get))),v});te(e,()=>{e.eventItem&&(s.value="init",a.value=!0,r.value=!1)});const{getItems:d,costItems:p,hasEnoughItems:k}=ee(),w=()=>{var m,v,T;(m=t.value)!=null&&m.need&&(k(t.value.need)?p((v=t.value)==null?void 0:v.need):s.value="noEnoughForExchange"),s.value!=="noEnoughForExchange"&&((T=t.value)!=null&&T.get)&&(d(t.value.get).length?s.value="noEnoughRoom":s.value="success"),r.value=!0},B=()=>{s.value="reject",r.value=!0},{setEvent:E}=j(),I=()=>{n.value&&n.value(),a.value=!1,E(t.value.type,!1)};return(m,v)=>N((_(),f("div",Te,[b(H,{"enter-active-class":"animate__animated animate__faster animate__zoomIn"},{default:O(()=>[c(a)?(_(),f("div",Ce,[x("button",{class:"i-ic:round-close absolute top-4.5 right-4 text-sm bg-gray-600 duration-200 cursor-pointer hover:bg-gray-800 hover:rotate-90",onClick:I}),c(i)?(_(),f("div",Le,se(c(i)),1)):S("",!0),c(r)?S("",!0):(_(),f("div",{key:1,class:"bg-gray-300/80 rounded px-1.5 py-1 mb-1",innerHTML:c(u)},null,8,Be)),x("div",Oe,[c(r)?(_(),f("button",{key:1,class:"action bg-gray-300/80",onClick:I},"结束")):(_(),f("div",Se,[x("button",{class:"action bg-blue-400/50",onClick:w},"同意"),x("button",{class:"action bg-rose-200",onClick:B},"拒绝")]))])])):S("",!0)]),_:1})],512)),[[R,c(a)]])}}),De={key:0,"i-ic:baseline-catching-pokemon":""},He={key:1,"i-mdi:treasure-chest-outline":""},Ae={key:2,"i-typcn:info-large-outline":""},Ke=F({__name:"MapBlock",props:{block:{},map:{}},emits:["autoMove"],setup(l){const e=l,t=g.STICK,n=C(()=>{var a;return(a=Object.keys(g).find(r=>g[r]===e.block.type))==null?void 0:a.toLowerCase()}),s=C(()=>{const{event:a,type:r}=e.block;return r!=g.ROAD||a?"bg-road":"bg-stick"}),i=C(()=>{const{x:a,y:r,type:h,event:y}=e.block,u=[n.value,(y==null?void 0:y.type)||""],d={tl:[-1,-1],tr:[-1,1],bl:[1,-1],br:[1,1]};for(const p in d){const k=Q.map(new Array(3),(w,B)=>{const[E,I]=d[p],[m,v]=[[a+E,r],[a,r+I],[a+E,r+I]][B];return e.map[m]&&e.map[m][v]?e.map[m][v].type:t});h==t?k.every(w=>w!=t)&&u.push(`r-${p}`):k.slice(0,2).every(w=>w===t)&&u.push(`r-${p}`)}return u});return(a,r)=>(_(),f("div",{class:Y(c(s)),onClick:r[0]||(r[0]=h=>a.$emit("autoMove"))},[x("div",{class:Y(["map-block text-white text-lg flex-center",c(i)]),style:ue({width:`${c(M).BLOCK_SIZE}px`,height:`${c(M).BLOCK_SIZE}px`})},[c(i).includes("hero")?(_(),f("span",De)):c(i).includes(c(ce))?(_(),f("span",He)):c(i).includes(c(le))?(_(),f("span",Ae)):S("",!0)],6)],2))}});const Ue=ne(Ke,[["__scopeId","data-v-a613b43c"]]),Ge=l=>(fe("data-v-dd5af148"),l=l(),ye(),l),Ne={class:"h-full relative overflow-hidden bg-stick"},Re={key:0,"i-ic:round-arrow-left":""},Ye={key:1,"i-ic:round-arrow-right":""},je={key:0,class:"absolute z-10 top-0 right-0 w-38 text-white text-right bg-black/40 rounded-bl p-2"},Fe=Ge(()=>x("div",{class:"hstack justify-end space-x-1 mt-1"},[x("div",{class:"tip-block bg-chest"},"包裹"),x("div",{class:"tip-block bg-event"},"事件"),x("div",{class:"tip-block bg-hero"},"你")],-1)),ze=F({__name:"map",setup(l){const e=L(!1),t=L(!0);setTimeout(()=>t.value=!1,5e3);const{event:n}=j(),s=L(new Me({id:8000001,name:"世界"})),i=ge();te(()=>n.mapUpdate,()=>{var u;return(u=i==null?void 0:i.proxy)==null?void 0:u.$forceUpdate()});const a=L(),r=()=>{if(!a.value)return;const{x:u,y:d}=s.value.hero,{row:p,col:k}=s.value.map;a.value.style.left=(M.WIDTH-M.BLOCK_SIZE*p)/2-(d-(k-1)/2)*M.BLOCK_SIZE+"px",a.value.style.top=(M.HEIGHT-M.BLOCK_SIZE*k)/2-(u-(p-1)/2)*M.BLOCK_SIZE+"px"};he(r),de(r);const h=new Ee(s.value),y=u=>{const d=new we(s.value.map,s.value.hero,u).find();h.autoMove(d)};return pe(h.stop),(u,d)=>{const p=me("router-link"),k=ke,w=be,B=Ue,E=$e;return _(),f("div",Ne,[b(p,{class:"btn absolute z-10 bottom-4 right-4 w-15 py-1 rounded border-white hover:bg-white hover:text-slate-700",to:"/"},{default:O(()=>[ve(" 回城 ")]),_:1}),b(H,{"enter-active-class":"animate__animated animate__faster animate__slideInUp","leave-active-class":"animate__animated animate__faster animate__slideOutDown"},{default:O(()=>[N(b(k,{class:"hero-info bottom-0 h-[270px] pt-2 pb-1 rounded-tr"},null,512),[[R,c(e)]])]),_:1}),b(H,{"enter-active-class":"animate__animated animate__faster animate__slideInDown","leave-active-class":"animate__animated animate__faster animate__slideOutUp"},{default:O(()=>[N(b(w,{transition:"bounce",class:"hero-info flex items-start space-x-6 pt-1 rounded-br"},null,512),[[R,c(e)]])]),_:1}),x("div",{class:Y(["absolute top-[199px] -left-5 z-20 w-10 py-1 bg-gray-400 text-white text-right duration-500 cursor-pointer",[c(e)&&"left-0"]]),border:"y r gray-300/50 rounded-r",onClick:d[0]||(d[0]=I=>e.value=!c(e))},[c(e)?(_(),f("span",Re)):(_(),f("span",Ye))],2),b(H,{"enter-active-class":"animate__animated animate__slideInRight","leave-active-class":"animate__animated animate__slideOutRight"},{default:O(()=>[c(t)?(_(),f("div",je,[x("div",null,se(c(s).name),1),Fe])):S("",!0)]),_:1}),x("div",{ref_key:"map",ref:a,class:"absolute duration-200 h-[800px] w-[800px]"},[(_(!0),f(P,null,V(c(s).map.data,(I,m)=>(_(),f("div",{key:`line-${m}`,class:"flex leading-0"},[(_(!0),f(P,null,V(I,(v,T)=>(_(),_e(B,{key:`block-${T}`,block:v,map:c(s).map.data,onAutoMove:K=>y(v)},null,8,["block","map","onAutoMove"]))),128))]))),128))],512),b(E,{"event-item":c(n).chest},null,8,["event-item"]),b(E,{"event-item":c(n).dialog},null,8,["event-item"])])}}});const Xe=ne(ze,[["__scopeId","data-v-dd5af148"]]);export{Xe as default};
